# プランニングドキュメント：Wake Word × GPT × Googleカレンダー音声アシスタント v1

**作成日**: 2025-11-20
**バージョン**: 1.1
**ステータス**: ドラフト
**前バージョンからの変更**: Phase 1 着手状況とブランチ/PR 情報を反映

---

## ⚡ クイックリファレンス（引き継ぎ用）

> 新規エージェントが3分で状況を把握するためのサマリー

**現在地**: Phase 1 - `src/` スケルトン実装＆設定まわり整備（35%完了）
**次のアクション**: RealtimeSession ↔ WakeWord/VAD の結線と Mock 会話ループ拡張
**ブロッカー**: API トークン未注入／Raspberry Pi の入出力デバイス検証待ち
**重要な決定事項**: Picovoice Porcupine + ChatGPT Realtime API + Google Calendar API の3本構成継続、開発ブランチ `feat/wake-gpt-plan` + Draft PR #1 を基軸に進行

### フェーズ進捗
- [x] Phase 0: 要件定義レビュー 完了
- [🔄] Phase 1: 音声/Realtime 土台（35%）
- [ ] Phase 2: カレンダー連携・通知（0%）
- [ ] Phase 3: Raspberry Pi 最適化（0%）
- [ ] Phase 4: 統合テスト/運用化（0%）

### 環境チェックリスト
- [ ] `OPENAI_API_KEY`（pc.dev）未設定
- [ ] `GOOGLE_REFRESH_TOKEN` 未設定（OAuth 認可待ち）

### 重要なファイルパス
- メインアプリ: `src/main.py`
- 設定ローダー: `src/config/loader.py`
- Realtime クライアント: `src/realtime/openai_realtime_client.py`
- カレンダーAPI: `src/calendar/google_calendar_client.py`
- Wake Word: `src/wakeword/porcupine_listener.py`
- 無音検知: `src/vad/vad_detector.py`

---

## 🔄 現在の作業状態

**最終更新**: 2025-11-20 18:05 JST
**進捗率**: 30%

### 直前の作業
- ✅ 完了: `src/config/loader.py` / `src/util/logging_utils.py` / `src/audio/*` / `src/vad/vad_detector.py` / `src/wakeword/porcupine_listener.py` を作成し、骨組みをコミット
- ✅ 完了: `.env.example`, `Makefile`, `requirements.txt`, `config/*.yaml`, `README.md`, `RUNBOOK.md` を整備
- 🔄 作業中: `src/realtime/openai_realtime_client.py` のモック会話ループ拡張と `src/main.py` への結線（50%）
  - 残タスク: WakeWord からのイベント連携、RealtimeSession のテレメトリ/例外処理、dry-run テストシナリオ
  - 停止位置: RealtimeSession.run() でプレースホルダ応答のみ
- ⏳ 次のタスク: Google Calendar クライアントの外部 API 実装と通知スケジューラ設計（Phase 2 着手条件）

### ブロッカー・未解決の問題
- [ ] API クレデンシャル（OpenAI/Google）が未配備（dry-run のみ可能）
- [ ] Raspberry Pi 実機でのマイク/スピーカー型番未確定
- [ ] Picovoice Porcupine の keyword / model ファイル未取得（`assets/models/` 空）

### 最近の変更履歴（直近5件）
| 日時 | 変更内容 | 関連ファイル |
|------|----------|---------------|
| 11-20 17:40 | プロジェクトスケルトン作成＆コミット | `src/**`, `config/**`, `requirements.txt`
| 11-20 17:45 | Draft PR #1 作成 | `feat/wake-gpt-plan`
| 11-20 17:20 | README / RUNBOOK / Makefile 記述 | `README.md`, `RUNBOOK.md`, `Makefile`
| 11-20 11:20 | プランテンプレ組み立て開始 | `docs/plan/20251120_PLAN1.md`
| 11-20 10:05 | 要件定義ドキュメント精読 | `docs/要件定義.md`

---

## 💭 主要な意思決定

- **ChatGPT Realtime API 採用**: 音声ストリーミング＋Function Calling が1 APIで完結するため（代替案: Whisper + GPT-4o）
- **Google Calendar Push 通知優先**: 即時性とクォータ節約を優先（代替案: ポーリングのみ）
- **Picovoice Porcupine**: 低消費電力でWake Word検出を安定提供（代替案: Snowboy）
- **設定ファイル分離**: `base.yaml` + 環境別で差分管理し、コード分岐を最小化

---

## 📝 変更済みファイル

| ファイルパス | 状態 | 変更内容 | 影響範囲 | 関連Phase |
|--------------|------|----------|----------|------------|
| `docs/plan/20251120_PLAN1.md` | 🔄 継続 | 進捗/ブロッカーを反映 | 計画共有 | Phase 0 |
| `src/config/loader.py` | ✅ 完了 | base+env マージ処理/Pydantic 型定義 | 設定読み込み | Phase 1 |
| `src/audio/input_stream.py`, `src/audio/output_stream.py` | ✅ 完了 | 音声 I/O 抽象クラス | 音声基盤 | Phase 1 |
| `src/realtime/openai_realtime_client.py` | 🔄 作業中 | RealtimeSession プレースホルダ（API結線待ち） | 会話制御 | Phase 1 |
| `src/main.py` | 🔄 作業中 | CLI / dry-run ロジック追加 | エントリーポイント共通化 | Phase 1 |

---

## 📋 目次

1. [要件概要](#要件概要)
2. [技術選定](#技術選定)
3. [データベース設計](#データベース設計)
4. [アーキテクチャ設計](#アーキテクチャ設計)
5. [実装フェーズ](#実装フェーズ)
6. [リスクと対応策](#リスクと対応策)
7. [完了条件](#完了条件)
8. [🐛 トラブルシューティング・既知の問題](#-トラブルシューティング既知の問題)
9. [参考リソース](#参考リソース)
10. [開発引き継ぎ詳細](#開発引き継ぎ詳細)
11. [🎯 最終ゴール](#-最終ゴール)

---

## 要件概要

### 背景・目的
- Wake Word で起動し、ChatGPT Realtime API と音声対話しながら Google カレンダーに予定を登録・通知する省電力アシスタントを構築する。

### 実装する機能
- **Wake Word 起動**: Porcupine で常時監視し、検出時に会話セッションを立ち上げ。
- **Realtime 会話＋予定抽出**: Realtime API の Function Calling で日時・内容を JSON 化。
- **Google カレンダー連携**: 予定登録・更新・削除と10分前リマインド通知。
- **無音検知と自動終了**: 10秒無発話でセッションを停止し省電力化。
- **通知後の会話継続**: 予定通知後もそのまま音声で変更・キャンセル指示可能。

### スコープ外
- マルチユーザー識別・話者分離
- 商用ライセンス運用（当面は個人ユース）
- Google以外のカレンダーサービス連携

---

## 技術選定

### 新規導入ライブラリ

| ライブラリ | バージョン | 選定理由 |
|-------------|------------|-----------|
| `picovoice` Porcupine SDK | 最新安定版 | Wake Word を超低レイテンシで実現するため
| `openai` | ^1.50.0 目安 | Realtime API / Function Calling クライアント
| `google-api-python-client` | ^2.154.0 目安 | Google Calendar API 連携
| `webrtcvad` or `py-webrtcvad` | 最新 | 軽量 VAD フォールバック
| `pydantic` | ^2.x | 設定/JSON スキーマ定義・検証

### 既存ライブラリの活用
- `logging` 標準モジュール: ログ一元管理
- `asyncio` / `websockets`: Realtime ストリーミング制御

---

## データベース設計

- 永続DBは不要。Google Calendar を唯一の予定ストアとし、ローカルには一時キューのみをメモリ管理。

---

## アーキテクチャ設計

### 1. ディレクトリ構造

```
src/
├── main.py
├── wakeword/
│   └── porcupine_listener.py
├── audio/
│   ├── input_stream.py
│   └── output_stream.py
├── realtime/
│   └── openai_realtime_client.py
├── calendar/
│   └── google_calendar_client.py
├── vad/
│   └── vad_detector.py
├── config/
│   └── loader.py
└── util/
    └── logging_utils.py
```

### 2. データフロー

`Porcupine Listener → Audio Input Stream → Realtime Session (LLM + Function Calling) → Calendar Client / Notification Queue → Audio Output`

### 3. 主要コンポーネント
- **`WakeWordListener`**: Porcupine のブロッキング待機、検出後のセッション起動通知。
- **`RealtimeSession`**: WebSocket管理、音声ストリーム送受信、Function Calling の JSON ハンドリング。
- **`GoogleCalendarClient`**: OAuth 認証、イベントCRUD、Push通知チャネル管理。
- **`ReminderScheduler`（Phase2で util に追加予定）**: Push/ポーリング結果を監視し、10分前のイベントを通知キューへ。
- **`VADDetector`**: `server_vad_idle_timeout_sec` に従い無音判定、10秒でセッション終了をトリガー。

---

## 実装フェーズ

### Phase 0: 事前準備（1日）
- [x] 要件定義精読とプラン作成
- [x] secrets テンプレ `.env.example` 精査 & 追記
- [x] Makefile / requirements たたき作成
- [ ] GitHub Actions ワークフロー草案

### Phase 1: 音声入出力 & Realtime 基盤（3-4日）
- [x] `src/util/logging_utils.py` で logger 整備
- [x] `src/config/loader.py` で base + env 差分マージ
- [x] `src/audio/input_stream.py` / `output_stream.py` の抽象化
- [x] `src/wakeword/porcupine_listener.py` + `src/vad/vad_detector.py` の雛形
- [🔄] `src/realtime/openai_realtime_client.py` の WebSocket 骨組みと VAD 連動
- [ ] テスト: ローカルで Wake Word → Realtime API 仮セッション（Google連携なし）

**実装のポイント**:
- 音声I/Oインターフェースは `async context manager` にし、セッション開始/終了を明瞭化。
- Realtime API の `server_vad_idle_timeout_sec` を config から渡す。

### Phase 2: カレンダー連携・通知（3日）
- [ ] `src/calendar/google_calendar_client.py` の CRUD 実装＋Push/ポーリング両対応
- [ ] `src/util/reminder_scheduler.py`（新規）で10分前通知キュー管理
- [ ] Realtime Session に Function Calling で返る JSON を Calendar Client へ橋渡し
- [ ] テスト: 偽イベントで10分前通知フロー（音声通知テキストのみ）

### Phase 3: Raspberry Pi 最適化（2日）
- [ ] `config/rpi.prod.yaml` のデバイスID調整
- [ ] USBマイク/スピーカー検出ロジックとフォールバック（`arecord -l` / `aplay -l`）
- [ ] systemd ユニット作成・RUNBOOK追記

### Phase 4: 統合テスト & 運用化（2日）
- [ ] 全フェーズ結合テスト（Wake Word → 予定登録 → 通知 → 会話継続）
- [ ] ログ・Usage Limit 監視ダッシュボード整備
- [ ] README / RUNBOOK / config サンプル更新

**合計見積もり**: 約 9-10 日

---

## リスクと対応策

| リスク | 内容 | 対応策 |
|--------|------|--------|
| Realtime API の仕様変更 | beta機能のため挙動が変わる可能性 | バージョンピン＋回帰テスト、REST fallback を検討 |
| Push通知利用不可 | 外部公開URLがない環境 | 5分以上ポーリング + exponential backoff をPhase2で実装 |
| マイク/スピーカー不一致 | RPi ごとにデバイス名が異なる | `arecord -l` で列挙し config に文字列一致で設定、RUNBOOK に記載 |
| APIキー漏洩リスク | `.env` に秘匿情報が残る懸念 | `.env.example` でテンプレ定義し、実運用は direnv/1Password 注入のみ許可 |

---

## 完了条件

### 機能要件
- [ ] Wake Word で会話セッションを確実に開始
- [ ] 予定登録・更新・削除が音声のみで完結
- [ ] 予定10分前通知と継続会話が安定動作

### 品質要件
- [ ] 10秒無音でセッション自動終了
- [ ] Google Push とポーリング双方で冗長化
- [ ] Python 3.11 + `ruff` チェックを全通過
- [ ] ローカル/CI で `python -m src.main --config config/pc.dev.yaml` が実行成功

### ドキュメント
- [ ] README にセットアップ手順
- [ ] RUNBOOK に鍵管理・systemd 起動手順
- [ ] config/ENV サンプル更新

---

## 🐛 トラブルシューティング・既知の問題

- 未発生（今後テスト中に更新予定）

---

## 参考リソース

### 公式ドキュメント
- OpenAI Realtime API: https://platform.openai.com/docs/guides/realtime
- Google Calendar API: https://developers.google.com/calendar/api
- Picovoice Porcupine: https://picovoice.ai/platform/porcupine/

### 関連プランドキュメント
- なし（本書が初版）

---

## 開発引き継ぎ詳細

### 📌 承認内容
- [x] Realtime API + Calendar API + Porcupine で MVP を構築
- [x] Raspberry Pi 常時稼働を最終到達点とする

### 🗂️ プロジェクト状態
- **技術スタック**: Python 3.11, OpenAI Realtime, Google Calendar API, Picovoice Porcupine
- **ブランチ / PR**: `feat/wake-gpt-plan`（Draft PR #1）
- **動作確認済み機能**: `--dry-run` で設定ロード・ログ初期化のみ確認済み
- **既知の問題**: APIキー未取得、Raspberry Pi の入出力デバイス・Porcupine keyword 未確定

### 🚀 実装優先順位
1. **Phase 1** - 音声/Realtime土台（ここが全機能の基礎）
2. **Phase 2** - カレンダー連携（価値の中心）
3. **Phase 3** - Raspberry Pi 実機最適化（量産を見据えた信頼性）

### ⚠️ 重要な注意事項
- **セキュリティ**: シークレットは `.env` ではなく安全なストアから注入
- **省電力運用**: Porcupine 常駐 + セッション時のみ高負荷処理

---

## 🎯 最終ゴール

**ユーザー体験**:
1. ユーザーが Wake Word で呼びかける
2. 音声会話で予定登録・確認・変更を完結
3. 予定10分前に自動で音声通知し、追加入力にも応じる

**技術的ゴール**: Python 3.11 で型安全・CI合格・Realtime/Calendar API の安定稼働・Raspberry Pi 常駐運用

---

**実装準備完了！🚀**
